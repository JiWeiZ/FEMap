# DNS

参考文章：

1. [阮一峰：DNS 原理入门](http://www.ruanyifeng.com/blog/2016/06/dns.html)
2. [写给前端工程师的 DNS 基础知识](https://juejin.im/entry/591969808d6d81005882e06f)
3. [DNS域名解析解剖](https://zhuanlan.zhihu.com/p/28305778)

## 一、DNS 是什么

答：DNS （Domain Name System，域名系统），是一个 **域名** 和 **IP** 相互映射的分布式数据库，能根据域名查出 IP 地址。

先从URL说起。一般来说，访问网络资源的途径就是访问其URL。URL的格式如下：

![img](https://upload-images.jianshu.io/upload_images/301420-e308f1b76b1bfc97.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/902/format/webp)

- protocol 协议，常用的协议是http，https，ftp等等
- hostname 主机地址，可以是域名，也可以是IP地址
- port 端口 http协议默认端口是：80端口，如果不写默认就是:80端口
- path 路径 网络资源在服务器中的指定路径
- parameter 参数 如果要向服务器传入参数，在这部分输入
- query 查询字符串 如果需要从服务器那里查询内容，在这里编辑
- fragment 片段 网页中可能会分为不同的片段，如果想访问网页后直接到达指定位置，可以在这部分设置

我们这里所说的域名实际上就是URL的hostname部分。互联网诞生之初是采用IP地址访问的，但IP很难记，直接通过ip访问网站让人很不爽，所以人们发明了DNS服务器，这样就能通过一串有规律的字符——域名访问网站了。

### 域名解析

通过域名访问网站的第一步就是进行域名解析，举例来说，如果你要访问域名`www.baidu.com`，首先要通过DNS查出它的IP地址。`www.baidu.com`对应的IP地址有2个：`111.13.100.91`和`111.13.100.92`（在地址栏键入这2个IP也可以访问百度主页），从`www.baidu.com`得到`111.13.100.91`的过程就是域名解析。

### 域名的层级

域名的层级结构如下：低级域名写在前面，并且以`.`分割：

```
三级域名.次级域名.顶级域名.根域名
```

还是以www.baidu.com为例，实际上www.baidu.com的真正域名是www.baidu.com.root。但是根域名对于世界上所有的域名来说都是一样的，所有平时省略不写。

根域名的下一级，叫做"顶级域名"（top-level domain，缩写为TLD），比如.com、.net；再下一级叫做"次级域名"（second-level domain，缩写为SLD），比如www.baidu.com里面的.baidu，这一级域名是用户可以注册的；再下一级是主机名（host），比如www.baidu.com里面的www，又称为"三级域名"，这是用户在自己的域里面为服务器分配的名称，是用户可以任意分配的。

像com这样的顶级域名，由ICANN 严格控制，是不允许随便创建的。顶级域名分两类:

1. 通用顶级域名
2. 国家顶级域名

通用顶级域名常见的如.com、 .org、.edu等， 国家顶级域名如我国的.cn， 美国的.us。还有一些常用的其他域名，如.me, .io等等。不同域名的价格也不尽相同。

*阿里云的域名申请截图*

![1545200423080](../.vuepress/public/assets/1545200423080.png)



**DNS依靠UDP传输**

## 二、查询过程

工具软件`dig`可以显示整个查询过程。（参考：[如何在windows中安装dig？](https://nil.uniza.sk/how-install-dig-dns-tool-windows-10/) 以及 [dig工具包BIND9.9.6.x86下载地址](ftp://ftp.nominum.com/pub/isc/bind9/9.9.6/BIND9.9.6.x86.zip)）

DNS查询过程可以分成2个部分，一个是本地DNS服务器（也就是本地递归服务器）做递归查询，一个是远程的域名服务器做迭代查询。

**浏览器 → 本地DNS服务器 → 检查缓存 → 远程域名服务器 → 浏览器**

1. 第1步，查找浏览器缓存。

   首先浏览器会去搜索自身的DNS缓存，看缓存有没有过期，过期的话缓存的解析就结束了（chrome缓存的时间只有一分钟，查看chrome的缓存可打开：chrome://net-internals/#dns ）。

2. 第2步，查找系统缓存。

   如果用户的浏览器缓存中没有，浏览器会查找操作系统缓存中是否有这个域名对应的DNS解析结果。
   在Windows中可以通过C:\Windows\System32\drivers\etc\hosts文件来设置，你可以将任何域名解析到任何能够访问的IP地址。如果你在这里指定了一个域名对应的IP地址，那么浏览器会首先使用这个IP地址。例如，我们在测试时可以将一个域名解析到一台测试服务器上，这样不用修改任何代码就能测试到单独服务器上的代码的业务逻辑是否正确。正是因为有这种本地DNS解析的规程，所以黑客就有可能通过修改你的域名解析来把特定的域名解析到它指定的IP地址上，导致这些域名被劫持。

3. 第3步，查找路由器缓存。
   如果系统缓存中也找不到，那么查询请求就会发向路由器，它一般会有自己的DNS缓存。

4. 第4步，查找ISP DNS 缓存。
   确认本地无缓存，会查询ISP DNS 缓存服务器。在我们的网络配置中都会有"DNS服务器地址"这一项，通常由给你接入互联网的应用提供商提供服务。大约80%的域名解析都到这里就已经完成了，所以ISP DNS主要承担了域名的解析工作。
   ![mark](https://user-gold-cdn.xitu.io/2017/5/15/bac5fa8fa23717a1a2eea13a61a4c04d?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

5. 第5步，递归搜索。
   如果前面几步都查询不到，就只能进行递归的搜索了。从根域、顶级域、二级域名等一次往下查询：

   1. 当域名服务器收到本地DNS服务器发出的迭代查询请求报文时，要么给出所要查询的IP地址，要么告诉本地服务器：“你下一步应当向哪一个域名服务器进行查询”。
   2. 根域名服务器通常是把自己知道的顶级域名服务器的IP地址告诉本地域名服务器，让本地域名服务器再向顶级域名服务器查询。
   3. 顶级域名服务器收到本地DNS服务器的查询请求后，要么给出所要查询的IP地址，要么告诉本地服务器下一步应当向哪一个权限域名服务器进行查询......最后，知道了所要解析的IP地址或报错，然后把这个结果返回给发起查询的主机。

![img](https://pic2.zhimg.com/80/v2-4fcef604d306308b0ed3c2ea4ed7ea09_hd.jpg)

## 三、相关优化